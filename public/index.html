<!DOCTYPE html>
<html>
  <head>
    <title>Lucidity</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="width=device-width">
  </head>
  <body>
    <h1>Lucidity</h1>
    <h5 id="count">Ask questions with 0 other users!</h5>
    <div id="textcontainer">
      <textarea id="query" cols=80 rows=6 onpaste="paste(event)" placeholder="Have a question?"></textarea><input id="send" type="submit" value="Ask!">
    </div>
    <div id="charcount"><p></p></div>
    <div id="stream">
    </div>
    <script src="jquery-1.10.2.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io.connect('http://localhost:3000');

      var message1 = "<div class='message1' id=";
      var message2 = "<div class='message2' id=";
      var admin = "<div class='admin' id=";
      var middle = "><p>";
      var close = "</p></div>";

      var count1 = "Ask questions with ";
      var count2 = " other users!";
      var countSingle = " other user!";

      var bool = true;
      
      var remaining = " characters remaining.";
      var remainingSingle = " character remaining.";
      var limit = 200;
      var characters = 0;

      var lastMessage;
      var rateLimit1 = "You are sending messages too quickly. Please wait ";
      var rateLimit2 = "and try again.";
      var second = " second ";
      var seconds = " seconds ";
      var localCount = 0;

      $('#query').focus(function() {
        if (characters == 199) {
          $('#charcount p').text((limit-characters) + remainingSingle);
        }
        else $('#charcount p').text((limit-characters) + remaining);
        $('#charcount').slideDown('slow');
      });
      $('#query').focusout(function() {
        $('#charcount').slideUp('slow');
      });

      var charCount = function(str) {
        var newlines = str.split('\n').length - 1;
        return str.length + 29 * newlines;
      };

      var send = function(e) {
        e.preventDefault();
        characters = charCount($('#query').val());
        if (characters <= limit) {
          var notEmpty = $('#query').val().replace(/\n/g, '');
          if (notEmpty) {
            if (lastMessage == undefined || lastMessage + 8000 < Date.now()) {
              socket.emit('query', {
                content: $('#query').val()
              });
              $('#query').val('');
              characters = 0;
              $('#charcount p').text((limit-characters) + remaining);
              lastMessage = Date.now();
              localCount++;
            }
            else {
              var wait = Math.ceil((lastMessage + 8000 - Date.now())/1000);
              if ($('#a'+localCount).length == 0) {
                $('#stream').prepend(admin + "a" + localCount + middle + close); 
              }
              if (wait == 1) {
                $('#a'+localCount+' p').text(rateLimit1 + wait + second
                                              + rateLimit2);
              }
              else {
                $('#a'+localCount+' p').text(rateLimit1 + wait + seconds 
                                              + rateLimit2);
              }
              $('#a'+localCount).slideDown('slow');
            }
          }
        }
      };

      $('#send').on('click', function(e) {
        send(e);
      });
      $('#query').keydown(function(e) {
        if (e.which == 13 && !e.shiftKey) {
          send(e);
        }
        else if (e.which == 13 && e.shiftKey) {
          setTimeout(function() {
            characters = charCount($('#query').val());
            if (characters > 200) {
              $('#charcount p').text((limit-characters) + remaining);
              $('#charcount').css( { 'background-color': '#996666' });
            }
            else if (characters == 199) {
              $('#charcount p').text((limit-characters) + remainingSingle);
              $('#charcount').css( { 'background-color': '#646464' });
            }
            else {
              $('#charcount p').text((limit-characters) + remaining);
              $('#charcount').css( { 'background-color': '#646464' });
            }
          }, 50);
        }
        else {
          setTimeout(function() {
            characters = charCount($('#query').val());
            if (characters > 200) {
              $('#charcount p').text((limit-characters) + remaining);
              $('#charcount').css( { 'background-color': '#996666' });
            }
            else if (characters == 199) {
              $('#charcount p').text((limit-characters) + remainingSingle);
              $('#charcount').css( { 'background-color': '#646464' });
            }
            else {
              $('#charcount p').text((limit-characters) + remaining);
              $('#charcount').css( { 'background-color': '#646464' });
            }
          }, 50);
        }
      });
      function paste(e) {
        setTimeout(function() {
          characters = charCount($('#query').val());
          if (characters > 200) {
            $('#charcount p').text((limit-characters) + remaining);
            $('#charcount').css( { 'background-color': '#996666' });
          }
          else if (characters == 199) {
            $('#charcount p').text((limit-characters) + remainingSingle);
            $('#charcount').css( { 'background-color': '#646464' });
          }
          else {
            $('#charcount p').text((limit-characters) + remaining);
            $('#charcount').css( { 'background-color': '#646464' });
          }
        }, 50);
      }

      socket.on('update', function (data) {
        if (data.admin) {
          $('#stream').prepend(admin + data.id + middle + close);
          $('#'+data.id+' p').text(data.content);
          $('#'+data.id).slideDown('slow');
          if (data.users === 1) {
            $('#count').text(count1 + data.users + countSingle);
          }
          else {
            $('#count').text(count1 + data.users + count2);
          }
        }
        else if (bool) {
          $('#stream').prepend(message1 + data.id + middle + close);
          if (data.content.length == 1) {
            $('#'+data.id+' p').text(data.content[0]);
            $('#'+data.id).slideDown('slow');
          }
          else {
            for (var i=0; i < data.content.length-1; i++) {
              if (data.content[i]) {
                $('#'+data.id+' p:last').text(data.content[i]);
              }
              else $('#'+data.id).append('<br>');
              $('#'+data.id).append('<p></p>');
            }
            if (data.content[data.content.length-1]) {
              $('#'+data.id+' p:last').text(data.content[data.content.length-1]);
            }
            else $('#'+data.id).append('<br>');
            $('#'+data.id).slideDown('slow');
          }
          if (data.users === 1) {
            $('#count').text(count1 + data.users + countSingle);
          }
          else {
            $('#count').text(count1 + data.users + count2);
          }
          bool = false;
        }
        else {
          $('#stream').prepend(message2 + data.id + middle + close);
          if (data.content.length == 1) {
            $('#'+data.id+' p').text(data.content[0]);
            $('#'+data.id).slideDown('slow');
          }
          else {
            for (var i=0; i < data.content.length-1; i++) {
              if (data.content[i]) {
                $('#'+data.id+' p:last').text(data.content[i]);
              }
              else $('#'+data.id).append('<br>');
              $('#'+data.id).append('<p></p>');
            }
            if (data.content[data.content.length-1]) {
              $('#'+data.id+' p:last').text(data.content[data.content.length-1]);
            }
            else $('#'+data.id).append('<br>');
            $('#'+data.id).slideDown('slow');
          }
          if (data.users === 1) {
            $('#count').text(count1 + data.users + countSingle);
          }
          else {
            $('#count').text(count1 + data.users + count2);
          }
          bool = true;
        }
      });
      socket.on('users', function (data) {
        if (data.users === 1) {
          $('#count').text(count1 + data.users + countSingle);
        }
        else {
          $('#count').text(count1 + data.users + count2);
        }
      });
    </script>
  </body>
</html>
